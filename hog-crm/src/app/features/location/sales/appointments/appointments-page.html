<section class="page">
  <!-- Header -->
  <div class="header">
    <div>
      <div class="breadcrumb">Sales / Activities &amp; Appointments</div>
      <h1 class="title">Appointments</h1>
      <p class="subtitle">Schedule &amp; track customer-facing meetings and tasks.</p>
    </div>

    <div class="actions">
      <button mat-raised-button color="primary" (click)="openAddDialog()">
        <mat-icon>add</mat-icon>
        New Appointment
      </button>
    </div>
  </div>

  <!-- Quick Add — ONE ROW -->
  <form class="card filterbar filterbar--qa" [formGroup]="quickAddForm" (ngSubmit)="quickAdd()">
    <mat-form-field appearance="outline" class="col">
      <mat-label>Customer</mat-label>
      <input matInput formControlName="customer" placeholder="e.g. ACME Corp" />
    </mat-form-field>

    <mat-form-field appearance="outline" class="col">
      <mat-label>Subject</mat-label>
      <input matInput formControlName="subject" placeholder="e.g. Showroom visit" />
    </mat-form-field>

    <mat-form-field appearance="outline" class="col col-180">
      <mat-label>Type</mat-label>
      <mat-select formControlName="type">
        <mat-option value="Meeting">Meeting</mat-option>
        <mat-option value="Call">Call</mat-option>
        <mat-option value="Task">Task</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" class="col col-220">
      <mat-label>Date &amp; Time</mat-label>
      <input matInput [matDatepicker]="qaDp" formControlName="datetime" />
      <mat-datepicker-toggle matSuffix [for]="qaDp"></mat-datepicker-toggle>
      <mat-datepicker #qaDp></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="outline" class="col col-200">
      <mat-label>Owner</mat-label>
      <mat-select formControlName="ownerId">
        <mat-option *ngFor="let o of owners" [value]="o.id">{{ o.name }}</mat-option>
      </mat-select>
    </mat-form-field>

    <div class="col col-actions">
      <button mat-flat-button color="primary" type="submit">Add</button>
    </div>
  </form>

  <!-- Filters — ONE ROW -->
  <form class="card filterbar filterbar--filters" [formGroup]="filterForm">
    <mat-form-field appearance="outline" class="col">
      <mat-label>Search</mat-label>
      <input matInput placeholder="Customer / Subject / Owner" formControlName="search" />
    </mat-form-field>

    <mat-form-field appearance="outline" class="col col-160">
      <mat-label>Type</mat-label>
      <mat-select formControlName="type">
        <mat-option value="">All</mat-option>
        <mat-option *ngFor="let t of types" [value]="t">{{ t }}</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" class="col col-200">
      <mat-label>Owner</mat-label>
      <mat-select formControlName="ownerId">
        <mat-option value="">All</mat-option>
        <mat-option *ngFor="let o of owners" [value]="o.id">{{ o.name }}</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" class="col col-160">
      <mat-label>Status</mat-label>
      <mat-select formControlName="status">
        <mat-option value="">All</mat-option>
        <mat-option *ngFor="let s of statuses" [value]="s">{{ s }}</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" class="col col-160">
      <mat-label>From</mat-label>
      <input matInput [matDatepicker]="fromDp" formControlName="from" />
      <mat-datepicker-toggle matSuffix [for]="fromDp"></mat-datepicker-toggle>
      <mat-datepicker #fromDp></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="outline" class="col col-160">
      <mat-label>To</mat-label>
      <input matInput [matDatepicker]="toDp" formControlName="to" />
      <mat-datepicker-toggle matSuffix [for]="toDp"></mat-datepicker-toggle>
      <mat-datepicker #toDp></mat-datepicker>
    </mat-form-field>

    <div class="col col-actions flex items-center gap-3 justify-end">
      <mat-checkbox formControlName="showAppointmentsOnly">Appointments only</mat-checkbox>
      <button mat-stroked-button type="button" (click)="clearFilters()">Reset</button>
    </div>
  </form>

  <!-- Table (same visual system as Opportunities) -->
  <div class="table-wrap">
    <table mat-table [dataSource]="filtered()" matSort class="opps-table">
      <!-- Select -->
      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef>
          <mat-checkbox class="cb-blue"
            [checked]="isAllSelected()"
            [indeterminate]="selection.selected.length && !isAllSelected()"
            (change)="masterToggle()"></mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let row">
          <mat-checkbox class="cb-blue"
            (click)="$event.stopPropagation()"
            (change)="$event ? selection.toggle(row) : null"
            [checked]="selection.isSelected(row)"></mat-checkbox>
        </td>
      </ng-container>

      <!-- Customer -->
      <ng-container matColumnDef="customer">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Customer</th>
        <td mat-cell *matCellDef="let r">
          <div class="cell-main"><span class="primary">{{ r.customer }}</span></div>
        </td>
      </ng-container>

      <!-- Subject -->
      <ng-container matColumnDef="subject">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Subject</th>
        <td mat-cell *matCellDef="let r">{{ r.subject }}</td>
      </ng-container>

      <!-- Type -->
      <ng-container matColumnDef="type">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Type</th>
        <td mat-cell *matCellDef="let r">
          <div class="chips">
            <span class="chip" [ngClass]="typeClass(r.type)">{{ r.type }}</span>
            <span *ngIf="r.isAppointment" class="chip bg-sky-100 text-sky-800 border-sky-100">Appointment</span>
          </div>
        </td>
      </ng-container>

      <!-- Owner -->
      <ng-container matColumnDef="owner">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Owner</th>
        <td mat-cell *matCellDef="let r">{{ r.ownerName }}</td>
      </ng-container>

      <!-- Datetime -->
      <ng-container matColumnDef="datetime">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Date/Time</th>
        <td mat-cell *matCellDef="let r">{{ r.datetime | date:'MMM d, y, h:mm a' }}</td>
      </ng-container>

      <!-- Status -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
        <td mat-cell *matCellDef="let r">
          <span class="chip" [ngClass]="statusClass(r.status)">{{ r.status }}</span>
        </td>
      </ng-container>

      <!-- Actions (sticky right) -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef class="mat-column-actions"></th>
        <td mat-cell *matCellDef="let r" class="mat-column-actions">
          <button class="action-btn" mat-stroked-button (click)="edit(r)">
            <mat-icon>edit</mat-icon><span class="btn-label">Edit</span>
          </button>
          <button class="action-btn" mat-stroked-button color="warn" (click)="delete(r)">
            <mat-icon>delete</mat-icon><span class="btn-label">Delete</span>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>
  </div>
</section>
