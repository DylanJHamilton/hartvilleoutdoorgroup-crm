<div class="tickets-page">
  <header class="header-row">
    <h1 class="title">Support — Tickets</h1>
    <div class="actions">
      <button class="btnAction" mat-stroked-button (click)="batch('assign')">
        <mat-icon>person_add</mat-icon>&nbsp;Assign
      </button>
      <button class="btnAction" mat-stroked-button (click)="batch('status')">
        <mat-icon>flag</mat-icon>&nbsp;Change Status
      </button>
      <button class="btnAction" mat-stroked-button (click)="batch('export')">
        <mat-icon>download</mat-icon>&nbsp;Export CSV
      </button>
      <button class="btnAction" mat-raised-button color="primary" (click)="openNewTicket()">
        <mat-icon>add</mat-icon>&nbsp;New Ticket
      </button>
    </div>
  </header>

  <!-- Filters -->
  <div class="filters-grid">
    <mat-form-field appearance="outline">
      <mat-label>Search</mat-label>
      <input
        matInput
        placeholder="subject, description, assignee"
        [value]="q()"
        (input)="q.set($event.target.value)" />
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Status</mat-label>
      <mat-select [value]="status()" (valueChange)="status.set($event)" multiple>
        <mat-option value="Open">Open</mat-option>
        <mat-option value="In Progress">In Progress</mat-option>
        <mat-option value="Waiting">Waiting</mat-option>
        <mat-option value="Resolved">Resolved</mat-option>
        <mat-option value="Closed">Closed</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Priority</mat-label>
      <mat-select [value]="priority()" (valueChange)="priority.set($event)" multiple>
        <mat-option value="Low">Low</mat-option>
        <mat-option value="Normal">Normal</mat-option>
        <mat-option value="High">High</mat-option>
        <mat-option value="Urgent">Urgent</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Owner</mat-label>
      <mat-select [value]="owner()" (valueChange)="owner.set($event)" multiple>
        <mat-option *ngFor="let o of owners()" [value]="o">{{ o }}</mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <div class="filters-footer">
    <button mat-button (click)="clearAll()">
      <mat-icon>close</mat-icon>&nbsp;Clear Filters
    </button>
  </div>

  <!-- Table -->
  <div class="table-wrap">
    <table mat-table [dataSource]="rows()" class="w-full">

      <!-- Select -->
      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef class="checkbox-col">
          <mat-checkbox (change)="masterToggle()" [checked]="isAllSelected()" aria-label="Toggle all"></mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let r" class="checkbox-col">
          <mat-checkbox
            (click)="$event.stopPropagation()"
            (change)="selection.toggle(r.id)"
            [checked]="selection.isSelected(r.id)"
            aria-label="Select row">
          </mat-checkbox>
        </td>
      </ng-container>

      <!-- Subject -->
      <ng-container matColumnDef="subject">
        <th mat-header-cell *matHeaderCellDef>Subject</th>
        <td mat-cell *matCellDef="let r">
          <a [routerLink]="['../tickets', r.id]" class="row-link">{{ r.subject }}</a>
          <div class="muted">
            <span class="badge" [class.badge-open]="r.status==='Open'" [class.badge-wait]="r.status==='Waiting'"
                  [class.badge-inprog]="r.status==='In Progress'"
                  [class.badge-resolved]="r.status==='Resolved'"
                  [class.badge-closed]="r.status==='Closed'">{{ r.status }}</span>
            <span class="dot">•</span>
            <span class="pill" [class.pill-high]="r.priority==='High'" [class.pill-urgent]="r.priority==='Urgent'">
              {{ r.priority }}
            </span>
          </div>
        </td>
      </ng-container>

      <!-- Status (text col for sorting/visibility) -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Status</th>
        <td mat-cell *matCellDef="let r">{{ r.status }}</td>
      </ng-container>

      <!-- Priority -->
      <ng-container matColumnDef="priority">
        <th mat-header-cell *matHeaderCellDef>Priority</th>
        <td mat-cell *matCellDef="let r">{{ r.priority }}</td>
      </ng-container>

      <!-- Assigned -->
      <ng-container matColumnDef="assignedTo">
        <th mat-header-cell *matHeaderCellDef>Assigned</th>
        <td mat-cell *matCellDef="let r">{{ r.assignedTo || 'Unassigned' }}</td>
      </ng-container>

      <!-- Due -->
      <ng-container matColumnDef="dueDate">
        <th mat-header-cell *matHeaderCellDef>Due</th>
        <td mat-cell *matCellDef="let r">{{ r.dueDate | date:'MMM d, h:mm a' }}</td>
      </ng-container>

      <!-- Updated -->
      <ng-container matColumnDef="updatedAt">
        <th mat-header-cell *matHeaderCellDef>Updated</th>
        <td mat-cell *matCellDef="let r">{{ r.updatedAt | date:'MMM d, h:mm a' }}</td>
      </ng-container>

      <!-- Rows -->
      <tr mat-header-row *matHeaderRowDef="displayedColumns" class="table-header"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

      <!-- Empty state -->
      <tr class="empty" *matNoDataRow>
        <td [attr.colspan]="displayedColumns.length">
          No tickets match your filters.
        </td>
      </tr>
    </table>
  </div>
</div>
